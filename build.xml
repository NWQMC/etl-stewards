<project name="QwStewardsEtl" default="default">
	<target name="default" depends="pullStation, pullResult"/>

	<target name="dev" depends="buildPackage, runPackage"/>

	<target name="ci" depends="buildPackage, compilePackageEmptyCiDB, runPackage"/>

	<target name="pullStation">
	    <echo>Pulling Stewards Station Data.</echo>
	    <exec executable="curl" output="${basedir}/station.xml">
	        <arg value="http://www.nrrig.mwa.ars.usda.gov/st10_wqp_test/service1.svc/station?countrycode=us"/>
	    </exec>
	</target>	
		
    <target name="pullResult">
        <echo>Pulling Stewards Rersult Data.</echo>
        <exec executable="curl" output="${basedir}/result.xml">
            <arg value="http://www.nrrig.mwa.ars.usda.gov/st10_wqp_test/service1.svc/result?countrycode=us"/>
        </exec>
    </target>   
	
   <target name="loadStation">
        <echo>Load the xml into staging database table</echo>
        <exec executable="sqlldr" failonerror="true">
            <arg value="ars_stewards/${ars_stewards_password_dev}@${instance}"/>
            <arg value="BAD=${basedir}/station.bad"/>
            <arg value="DISCARD=${basedir}/station.dsc"/>
            <arg value="CONTROL=${basedir}/station.ctl"/>
        </exec>
    </target>

    <target name="loadResult">
        <echo>Load the xml into staging database table</echo>
	    <exec executable="sqlldr" failonerror="true">
	        <arg value="ars_stewards/${ars_stewards_password_dev}@${instance}"/>
	        <arg value="BAD=${basedir}/result.bad"/>
	        <arg value="DISCARD=${basedir}/result.dsc"/>
	        <arg value="CONTROL=${basedir}/result.ctl"/>
	    </exec>
	</target>


	
	
	
	<target name="buildPackage">
		<echo>Rebuiling the etl database package and body</echo>
		<exec executable="sqlplus" failonerror="true">
			<arg value="${nwis_ws_star_username}/${nwis_ws_star_password}@${instance}"/>
			<arg value="@${basedir}/create_nad_objects.sql"/>
		</exec>
	</target>
		
	<target name="compilePackageEmptyCiDB">
		<echo>Rebuiling the etl database package and body with the empty_db flag set</echo>
		<exec executable="sqlplus" failonerror="true">
			<arg value="${nwis_ws_star_username}/${nwis_ws_star_password}@${instance}"/>
			<arg value="@${basedir}/emptyCiDB.sql"/>
		</exec>
	</target>
		
	<target name="runPackage">
		<echo>Running the main ETL Package</echo>
		<exec executable="sqlplus" failonerror="true">
			<arg value="${nwis_ws_star_username}/${nwis_ws_star_password}@${instance}"/>
			<arg value="@${basedir}/runPackage.sql"/>
			<arg value="${success_notify}"/>
			<arg value="${failure_notify}"/>
		</exec>
	</target>
			
	<target name="scpScript">
		<echo>Copy the script to ${nwis_host}</echo>
		<scp file="spool_out_all.sh" todir="nwis_user:${nwis_user_password}@${nwis_host}:/home/nwis_user" trust="true"/>
	</target>

	<target name="dos2unix">
		<echo>Fix cr/lf</echo>
		<sshexec host="${nwis_host}"
			trust="true"
			username="nwis_user"
			password="${nwis_user_password}"
			command="dos2unix spool_out_all.sh "/>
	</target>
	
	<target name="scpScriptB">
		<echo>Copy the script to ${nwis_host}</echo>
		<scp todir="nwis_user:${nwis_user_password}@${nwis_host}:/var/lib/mysql/copy_sitefile" trust="true">
			<fileset dir="copy_sitefile"/>
		</scp>
	</target>

	<target name="qwNwisEtl">
		<echo>Run the script</echo>
		<sshexec host="${nwis_host}"
			trust="true"
			failonerror="true"
			username="nwis_user"
			password="${nwis_user_password}"
			command="bash -e spool_out_all.sh "
		/>
	</target>

	<target name="defaultEros" depends="buildPackageEros, scpScriptEros, dos2unixEros, qwNwisEtlEros"/>

	<target name="buildPackageEros">
		<echo>Rebuiling the etl database package and body</echo>
		<exec executable="sqlplus" failonerror="true">
			<arg value="${nwis_ws_star_username}/${nwis_ws_star_password}@${instance}"/>
			<arg value="@${basedir}/create_nad_objects_eros.sql"/>
		</exec>
	</target>
		
	<target name="scpScriptEros">
		<echo>Copy the script to ${nwis_host}</echo>
		<scp todir="${nwis_user}:${nwis_user_password}@${nwis_host}:/home/nwis_user" trust="true">
		    <fileset dir=".">
		      <include name="copy_sitefile/*.sql"/>
		      <include name="spool_out_all_eros.sh"/>
		    </fileset>
		  </scp>
	</target>

	<target name="dos2unixEros">
		<echo>Fix cr/lf</echo>
		<sshexec host="${nwis_host}"
			trust="true"
			username="${nwis_user}"
			password="${nwis_user_password}"
			command="dos2unix spool_out_all_eros.sh "/>
	</target>
	
	<target name="qwNwisEtlEros">
		<echo>Run the script</echo>
		<sshexec host="${nwis_host}"
			trust="true"
			failonerror="true"
			username="nwis_user"
			password="${nwis_user_password}"
			command="bash -e spool_out_all_eros.sh "
		/>
	</target>

</project>